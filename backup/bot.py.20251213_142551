import asyncio
import logging
import os

from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from dotenv import load_dotenv

from db_manager import (
    find_participant_by_telegram_id,
    find_participant_by_ozon_id,
    create_participant,
    create_database,
)

from states import Registration
# –ò–ú–ü–û–†–¢ –î–õ–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ó–ê–ö–ê–ó–û–í
from orders_updater import update_orders_sheet, fill_customers_from_existing_orders 


# –≥—Ä—É–∑–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()
API_TOKEN = os.getenv("BOT_TOKEN")

if not API_TOKEN:
    raise RuntimeError("–ù–µ—Ç BOT_TOKEN –≤ .env, –ø—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª .env")

# –°–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ .env)
# –§–æ—Ä–º–∞—Ç –≤ .env: ADMIN_IDS=123456789,987654321
admin_ids_str = os.getenv("ADMIN_IDS", "")
if admin_ids_str:
    ADMIN_IDS = [int(x.strip()) for x in admin_ids_str.split(",") if x.strip()]
else:
    # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ .env, –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∑–¥–µ—Å—å
    ADMIN_IDS = [419985638]  # Artem (ID: 419985638)

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher(storage=MemoryStorage())


# =========================================================
# –°–ò–°–¢–ï–ú–ê –ü–†–û–í–ï–†–ö–ò –ü–†–ê–í –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
# =========================================================
def is_admin(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."""
    return user_id in ADMIN_IDS


# =========================================================
# –°–û–ó–î–ê–ù–ò–ï –ö–õ–ê–í–ò–ê–¢–£–† –° –ö–ù–û–ü–ö–ê–ú–ò
# =========================================================
def get_user_keyboard() -> ReplyKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
                KeyboardButton(text="üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã"),
            ],
            [
                KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å"),
            ],
        ],
        resize_keyboard=True,
        one_time_keyboard=False,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ Ozon ID"
    )
    return keyboard


def get_admin_keyboard() -> ReplyKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤."""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã"),
                KeyboardButton(text="üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
            ],
            [
                KeyboardButton(text="üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã"),
                KeyboardButton(text="üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"),
            ],
            [
                KeyboardButton(text="üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞"),
                KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
            ],
            [
                KeyboardButton(text="üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã"),
                KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å"),
            ],
        ],
        resize_keyboard=True,
        one_time_keyboard=False,
        input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ Ozon ID"
    )
    return keyboard


def get_keyboard(user_id: int) -> ReplyKeyboardMarkup:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if is_admin(user_id):
        return get_admin_keyboard()
    else:
        return get_user_keyboard()


# =========================================================
# 1. –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î–´ /START (–ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
# =========================================================
@dp.message(CommandStart())
async def start_handler(message: types.Message, state: FSMContext):
    user = message.from_user
    tg_id = user.id
    username = user.username
    first_name = user.first_name

    # –ø–∞—Ä—Å–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ /start <–∫–æ–¥>
    parts = message.text.split(maxsplit=1)
    referrer_id = None
    if len(parts) == 2:
        referrer_id = parts[1].strip()

    # –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ Telegram ID
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é Sheets –≤ asyncio.to_thread
    participant = await asyncio.to_thread(find_participant_by_telegram_id, tg_id) 

    if participant:
        # —É–∂–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ
        text = (
            f"–ü—Ä–∏–≤–µ—Ç, {first_name or username or '–¥—Ä—É–≥'}! üëã\n\n"
            "–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
        )
        await state.clear()
        await message.answer(text, reply_markup=get_keyboard(tg_id))
        return

    # –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –µ—â—ë –Ω–µ—Ç ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    await state.update_data(referrer_id=referrer_id)

    text = (
        f"–ü—Ä–∏–≤–µ—Ç, {first_name or username or '–¥—Ä—É–≥'}! üëã\n\n"
        "–ß—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–±—è –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ,\n"
        "–º–Ω–µ –Ω—É–∂–µ–Ω —Ç–≤–æ–π <b>Ozon ID (ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è)</b>.\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n"
        "–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å, –≥–¥–µ –µ–≥–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '‚ùì –ü–æ–º–æ—â—å'."
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(tg_id))
    await state.set_state(Registration.waiting_for_ozon_id)


# =========================================================
# 2. –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î–´ /TEST_DB (–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î)
# =========================================================
@dp.message(Command("test_db"))
async def test_db(message: types.Message):
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        await asyncio.to_thread(create_database)
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
        test_result = await asyncio.to_thread(find_participant_by_telegram_id, 0)
        
        await message.answer(
            f"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ\n"
            f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.",
            parse_mode="HTML",
            reply_markup=get_keyboard(message.from_user.id)
        )
    except Exception as e:
        await message.answer(
            f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ‚ùå\n<code>{e}</code>",
            parse_mode="HTML",
            reply_markup=get_keyboard(message.from_user.id)
        )

# =========================================================
# 3. –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î–´ /SYNC_ORDERS
# =========================================================
@dp.message(Command("sync_orders"))
async def sync_orders_handler(message: types.Message):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ª–∏—Å—Ç '–ó–∞–∫–∞–∑—ã', –≤—ã–∑—ã–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."""
    # #region agent log
    import json
    from datetime import datetime
    try:
        with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
            log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"N","location":"bot.py:185","message":"sync_orders_handler entry","data":{"user_id":message.from_user.id},"timestamp":int(datetime.now().timestamp()*1000)}
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
    except Exception as log_err:
        print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
    # #endregion
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if not is_admin(message.from_user.id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=get_keyboard(message.from_user.id)
        )
        return
    
    try:
        # #region agent log
        try:
            with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"O","location":"bot.py:196","message":"Calling update_orders_sheet","data":{},"timestamp":int(datetime.now().timestamp()*1000)}
                f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
        except Exception as log_err:
            print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
        # #endregion
        result = await asyncio.to_thread(update_orders_sheet)
        # #region agent log
        import json
        from datetime import datetime
        try:
            with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"H","location":"bot.py:210","message":"Sync result received","data":{"result_type":type(result).__name__,"result_keys":list(result.keys()) if isinstance(result, dict) else "not_dict","has_participants_count":"participants_with_orders_count" in result if isinstance(result, dict) else False,"has_period_start":"period_start" in result if isinstance(result, dict) else False,"has_period_end":"period_end" in result if isinstance(result, dict) else False},"timestamp":int(datetime.now().timestamp()*1000)}
                f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
        except Exception as log_err:
            print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
        # #endregion
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if not isinstance(result, dict):
            # #region agent log
            try:
                with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                    log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"Q","location":"bot.py:220","message":"Result is not dict","data":{"result_type":type(result).__name__,"result_value":str(result)[:200]},"timestamp":int(datetime.now().timestamp()*1000)}
                    f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
            except Exception as log_err:
                print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
            # #endregion
            await message.answer(
                "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.",
                reply_markup=get_keyboard(message.from_user.id)
            )
            return
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        # #region agent log
        try:
            with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"R","location":"bot.py:232","message":"Extracting period from result","data":{"has_period_start":"period_start" in result,"has_period_end":"period_end" in result,"period_start_type":type(result.get("period_start")).__name__ if "period_start" in result else "missing","period_end_type":type(result.get("period_end")).__name__ if "period_end" in result else "missing"},"timestamp":int(datetime.now().timestamp()*1000)}
                f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
        except Exception as log_err:
            print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
        # #endregion
        
        period_start = result.get("period_start")
        period_end = result.get("period_end")
        
        if period_start is None or period_end is None:
            # #region agent log
            try:
                with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                    log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"S","location":"bot.py:240","message":"Period missing in result","data":{"period_start":period_start is not None,"period_end":period_end is not None},"timestamp":int(datetime.now().timestamp()*1000)}
                    f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
            except Exception as log_err:
                print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
            # #endregion
            await message.answer(
                "‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–∏–æ–¥–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.",
                reply_markup=get_keyboard(message.from_user.id)
            )
            return
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥ (DD.MM.YYYY HH:MM)
        period_start_str = period_start.strftime("%d.%m.%Y %H:%M")
        period_end_str = period_end.strftime("%d.%m.%Y %H:%M")
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∑–∞ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –ø–µ—Ä–∏–æ–¥–∞
        first_day_stats = result.get("first_day_stats", {})
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        status_stats_text = ""
        if first_day_stats and first_day_stats.get("total", 0) > 0:
            first_day_date = period_start_str.split()[0]  # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
            status_stats_text = f"\n\nüìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {first_day_date}:</b>\n"
            status_stats_text += f"–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: <b>{first_day_stats['total']}</b>\n"
            
            statuses = first_day_stats.get("statuses", {})
            if statuses:
                # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
                sorted_statuses = sorted(statuses.items(), key=lambda x: x[1], reverse=True)
                for status, count in sorted_statuses:
                    percentage = (count / first_day_stats['total']) * 100
                    status_name = {
                        "delivered": "‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ",
                        "delivering": "üöö –í –¥–æ—Å—Ç–∞–≤–∫–µ",
                        "awaiting_packaging": "üì¶ –û–∂–∏–¥–∞–µ—Ç —É–ø–∞–∫–æ–≤–∫–∏",
                        "awaiting_deliver": "‚è≥ –û–∂–∏–¥–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏",
                        "cancelled": "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
                    }.get(status, status)
                    status_stats_text += f"{status_name}: <b>{count}</b> ({percentage:.1f}%)\n"
            
            if first_day_stats.get("active_count", 0) > 0:
                status_stats_text += f"\n‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: <b>{first_day_stats['active_count']}</b>"
        
        if result["count"] > 0:
            text = (
                f"üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ\n\n"
                f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ <b>{result['count']}</b> –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤\n"
                f"üë• –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ <b>{result['customers_count']}</b> –∫–ª–∏–µ–Ω—Ç–æ–≤ "
                f"(–Ω–æ–≤—ã—Ö: <b>{result['new_customers_count']}</b>)\n"
                f"üéØ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–æ–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–æ–∫—É–ø–∫—É: <b>{result.get('participants_with_orders_count', 0)}</b>\n\n"
                f"üìÖ <b>–ü–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</b>\n"
                f"–°: {period_start_str}\n"
                f"–ü–æ: {period_end_str}"
                f"{status_stats_text}"
            )
        else:
            text = (
                f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
                f"–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
                f"üìÖ <b>–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏:</b>\n"
                f"–°: {period_start_str}\n"
                f"–ü–æ: {period_end_str}"
                f"{status_stats_text}"
            )

        await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(message.from_user.id))
        
    except Exception as e:
        # #region agent log
        import json
        from datetime import datetime
        with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
            log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"I","location":"bot.py:230","message":"Exception in sync handler","data":{"error":str(e),"error_type":type(e).__name__},"timestamp":int(datetime.now().timestamp()*1000)}
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
        # #endregion
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ ‚ùå\n"
            f"<code>{e}</code>",
            parse_mode="HTML",
            reply_markup=get_keyboard(message.from_user.id)
        )


# =========================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ö–õ–ê–í–ò–ê–¢–£–†–´
# =========================================================
@dp.message(lambda message: message.text == "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã")
async def sync_orders_button_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã'."""
    # #region agent log
    import json
    from datetime import datetime
    try:
        with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
            log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"P","location":"bot.py:273","message":"sync_orders_button_handler entry","data":{"user_id":message.from_user.id},"timestamp":int(datetime.now().timestamp()*1000)}
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
    except Exception as log_err:
        print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
    # #endregion
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if not is_admin(message.from_user.id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=get_keyboard(message.from_user.id)
        )
        return
    await sync_orders_handler(message)


@dp.message(lambda message: message.text == "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def my_stats_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'."""
    user = message.from_user
    participant = await asyncio.to_thread(find_participant_by_telegram_id, user.id)
    
    if not participant:
        await message.answer(
            "‚ùå –¢—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=get_keyboard(user.id)
        )
        return
    
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ –ë–î
    text = (
        f"üìä <b>–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
        f"Ozon ID: <code>{participant.get('Ozon ID', '–ù–µ —É–∫–∞–∑–∞–Ω')}</code>\n"
        f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {participant.get('–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}\n\n"
        f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏."
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user.id))


@dp.message(lambda message: message.text == "üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã")
async def my_orders_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ú–æ–∏ –∑–∞–∫–∞–∑—ã'."""
    user = message.from_user
    participant = await asyncio.to_thread(find_participant_by_telegram_id, user.id)
    
    if not participant:
        await message.answer(
            "‚ùå –¢—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=get_keyboard(user.id)
        )
        return
    
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –ë–î
    ozon_id = participant.get('Ozon ID')
    text = (
        f"üì¶ <b>–¢–≤–æ–∏ –∑–∞–∫–∞–∑—ã</b>\n\n"
        f"Ozon ID: <code>{ozon_id}</code>\n\n"
        f"–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user.id))


@dp.message(lambda message: message.text == "‚ùì –ü–æ–º–æ—â—å")
async def help_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü–æ–º–æ—â—å'."""
    user_id = message.from_user.id
    is_admin_user = is_admin(user_id)
    
    text = (
        "‚ùì <b>–ü–æ–º–æ—â—å</b>\n\n"
        "üìù <b>–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–≤–æ–π Ozon ID?</b>\n"
        "1. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Ozon\n"
        "2. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª '–ü—Ä–æ—Ñ–∏–ª—å'\n"
        "3. –ù–∞–∂–º–∏ –Ω–∞ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n"
        "4. –¢–≤–æ–π ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã\n\n"
        "üí° <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é\n"
    )
    
    if is_admin_user:
        text += "/sync_orders - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)\n"
    
    text += "/test_db - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î\n\n"
    text += "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º."
    
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user_id))


@dp.message(lambda message: message.text == "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")
async def management_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    user_id = message.from_user.id
    
    if not is_admin(user_id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=get_keyboard(user_id)
        )
        return
    
    text = (
        "üë• <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</b>\n\n"
        "–§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n"
        "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç:\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞\n"
        "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user_id))


@dp.message(lambda message: message.text == "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞")
async def analytics_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    user_id = message.from_user.id
    
    if not is_admin(user_id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=get_keyboard(user_id)
        )
        return
    
    text = (
        "üìà <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>\n\n"
        "–§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n"
        "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç:\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–∫–∞–∑–∞–º\n"
        "‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏\n"
        "‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º"
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user_id))


@dp.message(lambda message: message.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
async def settings_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    user_id = message.from_user.id
    
    if not is_admin(user_id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.",
            reply_markup=get_keyboard(user_id)
        )
        return
    
    text = (
        "‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
        "–§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n"
        "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç:\n"
        "‚Ä¢ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–æ—Ç–∞\n"
        "‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
    )
    await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user_id))


@dp.message(lambda message: message.text == "üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã")
async def fill_old_customers_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã customers –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤."""
    user_id = message.from_user.id
    
    if not is_admin(user_id):
        await message.answer(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã",
            reply_markup=get_keyboard(user_id)
        )
        return
    
    await message.answer("‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–∫–∞–∑–æ–≤...", reply_markup=get_keyboard(user_id))
    
    try:
        result = await asyncio.to_thread(fill_customers_from_existing_orders)
        
        text = (
            f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
            f"üì¶ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤: <b>{result['processed_orders']}</b>\n"
            f"üë• –°–æ–∑–¥–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: <b>{result['customers_created']}</b>\n"
            f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: <b>{result['customers_updated']}</b>\n"
            f"üìä –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: <b>{result['total_customers']}</b>"
        )
        
        await message.answer(text, parse_mode="HTML", reply_markup=get_keyboard(user_id))
    except Exception as e:
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}",
            reply_markup=get_keyboard(user_id)
        )


# =========================================================
# 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–°–¢–û–Ø–ù–ò–Ø (–ü–æ–ª—É—á–µ–Ω–∏–µ Ozon ID)
# =========================================================
@dp.message(Registration.waiting_for_ozon_id)
async def process_ozon_id(message: types.Message, state: FSMContext):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞ –≤–º–µ—Å—Ç–æ –≤–≤–æ–¥–∞ ID
    button_texts = ["üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã", "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã", 
                     "‚ùì –ü–æ–º–æ—â—å", "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"]
    if message.text in button_texts:
        # –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ—ë —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
        return
    
    ozon_id = message.text.strip()
    user = message.from_user

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –≤—ã–≥–ª—è–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
    if not ozon_id.isdigit():
        await message.answer(
            "Ozon ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
            reply_markup=get_keyboard(user.id)
        )
        return

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —Ç–∞–∫–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —É–∂–µ
    exist = await asyncio.to_thread(find_participant_by_ozon_id, ozon_id) 
    if exist:
        await message.answer(
            "–¢–∞–∫–æ–π Ozon ID —É–∂–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ. –ï—Å–ª–∏ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –Ω–∞–ø–∏—à–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
            reply_markup=get_keyboard(user.id)
        )
        await state.clear() 
        return

    # –¥–æ—Å—Ç–∞—ë–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π referrer_id
    data = await state.get_data()
    referrer_id = data.get("referrer_id")

    # —Å–æ–∑–¥–∞—ë–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
    await asyncio.to_thread( 
        create_participant,
        ozon_id=ozon_id,
        tg_id=user.id,
        username=user.username,
        first_name=user.first_name,
        referrer_id=referrer_id,
        language=message.from_user.language_code
    )

    await state.clear()

    await message.answer(
        f"–ì–æ—Ç–æ–≤–æ, {user.first_name or '–¥—Ä—É–≥'}! –¢—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n"
        f"–¢–≤–æ–π Ozon ID: {ozon_id}\n\n"
        f"–¢–µ–ø–µ—Ä—å —è —Å–º–æ–≥—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–≤–æ–∏ –ø–æ–∫—É–ø–∫–∏ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã üòä",
        reply_markup=get_keyboard(user.id)
    )


# =========================================================
# 5. –ó–ê–ü–£–°–ö –ë–û–¢–ê
# =========================================================
async def main():
    # #region agent log
    import json
    from datetime import datetime
    try:
        with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
            log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"L","location":"bot.py:471","message":"Bot main() started","data":{},"timestamp":int(datetime.now().timestamp()*1000)}
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
    except Exception as log_err:
        print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
    # #endregion
    try:
        await dp.start_polling(bot)
    except Exception as e:
        # #region agent log
        import json
        from datetime import datetime
        try:
            with open(r'c:\telegram-ref-bot\.cursor\debug.log', 'a', encoding='utf-8') as f:
                log_entry = {"sessionId":"debug-session","runId":"run1","hypothesisId":"M","location":"bot.py:472","message":"Exception in main()","data":{"error":str(e),"error_type":type(e).__name__},"timestamp":int(datetime.now().timestamp()*1000)}
                f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
        except Exception as log_err:
            print(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {log_err}")
        # #endregion
        print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ: {e}")
        import traceback
        traceback.print_exc()
        raise


if __name__ == "__main__":
    asyncio.run(main())